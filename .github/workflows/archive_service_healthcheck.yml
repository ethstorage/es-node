name: Archive Service Healthcheck

env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true
  ARCHIVE_BLOB_SIDECARS_URL: https://archive.mainnet.ethstorage.io:9645/eth/v1/beacon/blob_sidecars/13164810?indices=3
  ARCHIVE_BLOB_PREFIX: 0x31000000f000ac44aa0a1981e2

on:
  schedule:
    # Every 8 hours (UTC)
    - cron: '0 */8 * * *'
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check blob_sidecars endpoint
        id: check_endpoint
        shell: bash
        run: |
          set -euo pipefail

          url='${{ env.ARCHIVE_BLOB_SIDECARS_URL }}'
          expected_blob_prefix='${{ env.ARCHIVE_BLOB_PREFIX }}'

          resp_file="${RUNNER_TEMP}/blob_sidecars.json"

          # Ensure file exists so it can be attached in the failure email.
          : > "$resp_file"

          # Capture status code; use retries/timeouts to reduce flakiness.
          code="$(
            curl --silent --show-error --location \
              --retry 3 --retry-delay 5 --retry-all-errors \
              --connect-timeout 10 --max-time 30 \
              --output "$resp_file" --write-out '%{http_code}' \
              "$url" \
              || echo '000'
          )"

          echo "HTTP status: $code"
          if [[ "$code" != "200" ]]; then
            failure_detail="Unexpected HTTP status code: expected 200, got ${code}"
            echo "failure_detail=$failure_detail" >> $GITHUB_OUTPUT
            exit 1
          fi

          blob="$(jq -r '.data[0].blob // empty' "$resp_file")"
          if [[ -z "$blob" ]]; then
            echo "failure_detail=Missing .data[0].blob in response" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$blob" != "${expected_blob_prefix}"* ]]; then
            echo "failure_detail=Blob data mismatch" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Blob data OK"

      - name: Decide whether to send daily success email
        id: daily_success
        shell: bash
        run: |
          set -euo pipefail

          send=false

          # Manual runs: always email on success.
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            send=true
          elif [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            # Scheduled runs: every 8 hours (00/08/16 UTC). Send success email only once per day.
            hour_utc="$(date -u +%H)"
            if [[ "$hour_utc" == "00" ]]; then
              send=true
            fi
          fi

          # Debug
          send=true

          echo "Event: ${GITHUB_EVENT_NAME}"
          echo "send=$send" >> "$GITHUB_OUTPUT"

      - name: Send daily success email
        if: ${{ success() && steps.daily_success.outputs.send == 'true' }}
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.ARCHIVE_SERVICE_SMTP_USERNAME }}
          password: ${{ secrets.ARCHIVE_SERVICE_SMTP_PASSWORD }}
          from: ES Archive Service
          to: ${{ secrets.ARCHIVE_SERVICE_EMAIL_TO }}
          subject: "✅ Archive Service OK"
          body: |
            Daily success report: archive service health check passed.

            URL:
            ${{ env.ARCHIVE_BLOB_SIDECARS_URL }}

      - name: Send email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.ARCHIVE_SERVICE_SMTP_USERNAME }}
          password: ${{ secrets.ARCHIVE_SERVICE_SMTP_PASSWORD }}
          from: ES Archive Service
          to: ${{ secrets.ARCHIVE_SERVICE_EMAIL_TO }}
          subject: "❌ Archive Service FAILED"
          attachments: ${{ runner.temp }}/blob_sidecars.json
          body: |
            The archive service health check failed.

            Event: ${{ github.event_name }}
            URL: ${{ env.ARCHIVE_BLOB_SIDECARS_URL }}

            ${{ steps.check_endpoint.outputs.failure_detail }}

            Full response is attached: blob_sidecars.json

            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
